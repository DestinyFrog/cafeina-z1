require"z1.tools.Svg"require"z1.Handling"BORDER=20;STANDARD_LIGATION_SIZE=30;Plugin={svg=Svg:new()}function Plugin:new(a)local b={tags=a.tags,atoms=a.atoms,ligations=a.ligations}setmetatable(b,self)self.__index=self;return b end;function Plugin:build()self:calcAtomsPosition()local c=self:measureBounds()if c~=nil then return nil,c end;c=self:drawAtom()if c~=nil then return nil,c end;c=self:drawLigation()if c~=nil then return nil,c end;local d,e=self.svg:build(self.width,self.height)return d,e end;function Plugin:calcAtomsPosition(f,g,h,i)if f==nil then f=self.atoms[1]end;if f.already==true then return end;if h and g then if not h.angle then local j=f.parent_ligation and f.parent_ligation.angle or 0;local k=j+180;local l=360/f.ligation_num;local m=k+l*(i+(f.parent_ligation and 1 or 0))h.angle=math.floor(m%360)end end;local n=0;local o=0;if g~=nil and h then local p=math.pi*h.angle/180;n=g.x+math.cos(p)*STANDARD_LIGATION_SIZE;o=g.y+math.sin(p)*STANDARD_LIGATION_SIZE end;f.x=n;f.y=o;f.already=true;for q,r in ipairs(f.ligations)do self:calcAtomsPosition(r.to,f,r,q)end end;function Plugin:drawAtom()return Error:new("Method drawAtom not Implemented")end;function Plugin:drawLigation()return Error:new("Method drawLigation not Implemented")end;function Plugin:measureBounds()local s=0;local t=0;local u=0;local v=0;for w,f in ipairs(self.atoms)do local n=f["x"]local o=f["y"]if f["symbol"]=="X"then goto x end;if n>u then u=n end;if o>v then v=o end;if n<s then s=n end;if o<t then t=o end::x::end;local y=u+-s;local z=v+-t;self.width=BORDER*2+y;self.height=BORDER*2+z;self.center_x=BORDER+math.abs(s)self.center_y=BORDER+math.abs(t)return nil end