require"z1.plugins.Plugin"require"z1.tools.z13"Z13Plugin={}function Z13Plugin:new(a)local b={z13=Z13:new(),atoms=a.atoms}setmetatable(b,self)self.__index=self;return b end;function Z13Plugin:measureBounds()local c=0;local d=0;local e=0;local f=0;local g=0;local h=0;for i,j in ipairs(self.atoms)do local k=j["x"]local l=j["y"]local m=j["z"]if j["symbol"]=="X"then goto n end;if k>f then f=k end;if l>g then g=l end;if m>h then h=m end;if k<c then c=k end;if l<d then d=l end;if m<e then e=m end::n::end;self.width=f+math.abs(c)self.height=g+math.abs(d)self.depth=h+math.abs(e)self.center_x=c+self.width/2;self.center_y=d+self.height/2;self.center_z=e+self.depth/2;return nil end;function Z13Plugin:calcAtomsPosition(j,o,p,q)if j==nil then j=self.atoms[1]end;if j.already==true then return end;local k=0;local l=0;local m=0;if o~=nil and p~=nil then local r=j.atomic_radius+o.atomic_radius;if p.type=="iÃ´nica"then r=r+60 else r=r-20 end;if p and o then if not p.angle then local s=j.parent_ligation and j.parent_ligation.angle or 0;local t=s;local u=360/o.ligation_num;local v=t+u*(q-1+(j.parent_ligation and 1 or 0))p.angle=math.floor(v%360)end end;if not p.angle3d then p.angle3d={(p.angle or 0)+90,90}end;local w=math.pi*p.angle3d[1]/180;local x=math.pi*p.angle3d[2]/180;k=o.x+r*math.sin(w)*math.cos(x)l=o.y+r*math.cos(w)m=o.z+r*math.sin(w)*math.sin(x)end;j.x=math.floor(k)j.y=math.floor(l)j.z=math.floor(m)j.already=true;for y,z in ipairs(j.ligations)do self:calcAtomsPosition(z.to,j,z,y)end end;function Z13Plugin:drawAtom()for i,j in ipairs(self.atoms)do if j.symbol=="X"then goto n end;self.z13:add(j.color,j.atomic_radius,j.x-self.center_x,j.y-self.center_y,j.z-self.center_z)::n::end;return nil end;function Z13Plugin:build()self:calcAtomsPosition()self:measureBounds()local A=self:drawAtom()if A~=nil then return nil,A end;local B,C=self.z13:build(self.width,self.height,self.depth)return B,C end